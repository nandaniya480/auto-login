const WORKDAY_MS=306e5,WEEKLY_TARGET_MS=153e6,USE_TEST_TIME=!1,today=new Date,loginForm=document.getElementById("loginForm"),timeDisplay=document.getElementById("timeDisplay"),userIdInput=document.getElementById("userIdInput"),passwordInput=document.getElementById("passwordInput"),saveCredsButton=document.getElementById("saveCreds"),refreshButton=document.getElementById("refreshButton");function getNow(){const[e,t]=TEST_HH_MM.split(":").map(Number);new Date(today.getFullYear(),today.getMonth(),today.getDate(),e,t);return new Date}function getCurrentTimeStr(e=getNow()){return e.toTimeString().slice(0,5)}function formatTimeReadable(e){const t=Math.floor(e/6e4);return`${Math.floor(t/60)}h ${t%60}m`}function createTimeObj(e,t){const[o,n]=e.split(":").map(Number);return new Date(t.getFullYear(),t.getMonth(),t.getDate(),o,n)}function triggerLogin(e,t){chrome.runtime.sendMessage({action:"openAndScrape",userId:e,password:t})}function updateTimeDisplay(){chrome.storage.local.get(null,(e=>{const t=e.timeData||{},o=getNow(),n=t[o.toLocaleDateString("en-GB")];if(!n||0===n.length)return void updateUI("N/A","N/A","N/A","N/A",o,0,153e6);let a=0,r=0,s=null;for(let e=0;e<n.length;e+=2){const t=n[e],i=n[e+1]||getCurrentTimeStr(o),l=createTimeObj(t,o),d=createTimeObj(i,o);if(s||(s=l),a+=d-l,e+2<n.length){r+=createTimeObj(n[e+2],o)-d}}let i=new Date(s?.getTime()+306e5+r||o);(o.getHours()<13||13===o.getHours()&&o.getMinutes()<30)&&(i=new Date(i.getTime()+36e5));const l=Math.max(306e5-a,0);let d=0;const u=new Date(o),m=u.getDay(),g=u.getDate()-m+(0===m?-6:1);u.setDate(g),u.setHours(0,0,0,0);for(const e in t){const[n,a,r]=e.split("/"),s=new Date(`${r}-${a}-${n}`);s.setHours(0,0,0,0);if(s.getDay()>=1&&s.getDay()<=6&&s>=u&&s<=o){const o=t[e];for(let e=0;e<o.length;e+=2){const t=createTimeObj(o[e],s);d+=createTimeObj(o[e+1]||getCurrentTimeStr(),s)-t}}}const c=Math.max(153e6-d,0);updateUI(formatTimeReadable(a),formatTimeReadable(r),i,formatTimeReadable(l),o,d,c),refreshButton.textContent="Refresh",refreshButton.disabled=!1,refreshButton.style.backgroundColor="#2ecc71"}))}function updateUI(e,t,o,n,a,r,s){document.getElementById("total-in").textContent=e,document.getElementById("total-out").textContent=t,document.getElementById("escape-time").textContent=new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0}),document.getElementById("refreshedAt").textContent=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}),document.getElementById("remaining").textContent=n,document.getElementById("week-total-in").textContent=formatTimeReadable(r),document.getElementById("week-remaining").textContent=formatTimeReadable(s)}chrome.storage.local.get(["userId","password","timeData"],(e=>{e.userId&&e.password?(loginForm.style.display="none",timeDisplay.style.display="block"):(loginForm.style.display="block",timeDisplay.style.display="none")})),saveCredsButton.addEventListener("click",(()=>{const e=userIdInput.value.trim(),t=passwordInput.value.trim();e&&t?chrome.storage.local.set({userId:e,password:t},(()=>{saveCredsButton.textContent="Saved!",saveCredsButton.style.backgroundColor="#27ae60",triggerLogin(e,t),setTimeout((()=>{loginForm.style.display="none",timeDisplay.style.display="block",updateTimeDisplay(),refreshButton.textContent="Loading...",refreshButton.disabled=!0,refreshButton.style.backgroundColor="#95a5a6"}),1e3)})):(saveCredsButton.textContent="Please fill both fields",saveCredsButton.style.backgroundColor="#e74c3c",setTimeout((()=>{saveCredsButton.textContent="Save & Login",saveCredsButton.style.backgroundColor="#2ecc71"}),2e3))})),refreshButton.addEventListener("click",(()=>{chrome.storage.local.get(["timeData","userId","password"],(e=>{const t=e.timeData||{};delete t[today.toLocaleDateString("en-GB")],chrome.storage.local.set({timeData:t},(()=>{e.userId&&e.password&&(triggerLogin(e.userId,e.password),refreshButton.textContent="Loading...",refreshButton.disabled=!0,refreshButton.style.backgroundColor="#95a5a6",updateTimeDisplay())}))}))})),updateTimeDisplay(),setInterval(updateTimeDisplay,1e3);