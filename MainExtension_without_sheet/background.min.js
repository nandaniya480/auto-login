function handleLoginAndScrape(e){chrome.storage.local.set({generated:"yes"}),chrome.tabs.create({url:"http://192.168.1.200:88/COSEC/Login/Login",active:!1},(t=>{chrome.tabs.onUpdated.addListener((function n(o,a){o===t.id&&"complete"===a.status&&(chrome.tabs.onUpdated.removeListener(n),chrome.scripting.executeScript({target:{tabId:t.id},function:loginToCosec,args:[e.userId,e.password]}))}))}))}function loginToCosec(e,t){const n=document.getElementById("loginid"),o=document.getElementById("pwd"),a=document.getElementById("btnlogin");n&&o&&a&&(n.value=e,o.value=t,a.click())}function fetchAndUpdateData(e){return new Promise((t=>{const n="http://192.168.1.200:88";Promise.all([getCookie(n,"ASP.NET_SessionId"),getCookie(n,"UserID"),getCookie(n,"Password")]).then((([n,o,a])=>{if(!n?.value)return console.error("ASP.NET_SessionId not found"),void t({error:"No session"});processPunchData(e,n.value,o?.value,a?.value,t)}))}))}function getCookie(e,t){return new Promise((n=>{chrome.cookies.get({url:e,name:t},n)}))}async function processPunchData(e,t,n,o,a){const r=new Date,s=r.getDay(),i=new Date(r);i.setDate(r.getDate()-(s+6)%7);const c=[];for(let e=0;e<5;e++){const t=new Date(i);t.setDate(i.getDate()+e),t<=r&&c.push(formatDate(t))}if(1===s){const e=new Date(r);e.setDate(r.getDate()-3),c.unshift(formatDate(e))}console.log("datesToFetch",c);const u=c.filter((e=>{const t=new Date(e).getDay();return 0!==t&&6!==t}));console.log("workingDays",u);const l=u.slice(-2);console.log("lastTwoWorkingDays",l);const d=Array.from(new Set([...u,...l]));console.log("allUniqueDates",d);const{generated:m}=await chrome.storage.local.get("generated"),g={},h=d.map((a=>new Promise((r=>{fetchPunchDataForDate(e,t,n,o,a,(e=>{Object.assign(g,e),r()}))}))));await Promise.all(h),chrome.storage.local.set({timeData:g}),"yes"===m&&(chrome.storage.local.remove("generated"),closeGeneratedTab()),a(g)}function closeGeneratedTab(){chrome.tabs.query({url:"http://192.168.1.200:88/COSEC/Default/Default*"},(e=>{e.length>0&&chrome.tabs.remove(e[0].id)}))}async function fetchPunchDataForDate(e,t,n,o,a,r){const s=`http://192.168.1.200:88/cosec/api/NPunchView/changePDateSelection/?token=${e}`,{userId:i}=await chrome.storage.local.get("userId"),c={UserId:i,PDate:a,DateSelection:4,AlwMonth:1};fetch(s,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8",Cookie:`UserID=${n}; Password=${o}; ASP.NET_SessionId=${t}; ProductID=COSEC`},body:JSON.stringify(c)}).then((e=>e.json())).then((e=>{const t=groupPunchData(e?.result?.grdData||[]);r(t)})).catch((e=>{console.error(`Error fetching data for ${a}`,e),r({[a]:[]})}))}function groupPunchData(e){const t={};e.forEach((e=>{const n=extractDateAndTime(e.EDatetime);n&&(t[n.date]=t[n.date]||[],t[n.date].push(n.time))}));const n={};for(const e in t)n[e]=addBreak(t[e],e);return n}function addBreak(e,t){const n=toMinutes("13:30"),o=toMinutes("14:30"),a=60*(new Date).getHours()+(new Date).getMinutes(),r=formatDate(new Date)===t;if(a<n&&r)return e;const s=e.map(((e,t)=>({type:t%2==0?"in":"out",time:e}))),i=getStatusAtTime(s,n-.5),c=getStatusAtTime(s,o+.5),u=s.filter((e=>{const t=toMinutes(e.time);return t<n||t>o}));return"in"===i&&"in"===c?u.push({type:"out",time:"13:30"},{type:"in",time:"14:30"}):"in"===i?u.push({type:"out",time:"13:30"}):"in"===c&&u.push({type:"in",time:"14:30"}),u.sort(((e,t)=>toMinutes(e.time)-toMinutes(t.time))).map((e=>e.time))}function getStatusAtTime(e,t){let n="out";for(const o of e){if(toMinutes(o.time)>t)break;n="in"===n?"out":"in"}return n}function extractDateAndTime(e){if(!e)return null;const[t,n]=e.split(" ");if(!t||!n)return null;const[o,a]=n.split(":").map(Number);return isNaN(o)||isNaN(a)?null:{date:t,time:`${String(o).padStart(2,"0")}:${String(a).padStart(2,"0")}`}}function formatDate(e){return e.toLocaleDateString("en-GB")}function toMinutes(e){const[t,n]=e.split(":").map(Number);return 60*t+n}chrome.runtime.onMessage.addListener(((e,t,n)=>{"getSessionIdAndCallAPI"===e.action?fetchAndUpdateData(e.token):"openAndScrape"===e.action&&handleLoginAndScrape(e)}));